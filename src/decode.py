import base64
from Crypto.Cipher import AES
from binascii import a2b_hex
import json


# 解密后，去掉补足的空格用strip() 去掉
def decrypt(text,key,iv):
    key = a2b_hex(key)
    iv = a2b_hex(iv)
    mode = AES.MODE_CBC
    cryptos = AES.new(key, mode, iv)
    plain_text = cryptos.decrypt(a2b_hex(text))
    return bytes.decode(plain_text).rstrip('\0')



def decode_token_login(response,time):
    key = "2f6c6f67696e5f6170692f746f6b656e"
    iv = int_to_byte_big_six(time).hex() + "00000000000000000000"
    d = decrypt(response, key, iv)
    d = remove_invisible_chars(d)
    return d
def decode_email(response,time):
    key = "2f6c6f67696e5f6170692f656d61696c"
    iv = int_to_byte_big_six(time).hex() + "00000000000000000000"
    d = decrypt(response, key, iv)
    d = remove_invisible_chars(d)
    return d

def decode_all_data(token_login_res,nft_used_info_res,time):
    j = json.loads(token_login_res)
    data = j["data"]
    # # 获取key
    access_01 = data["access_01"]
    # # 获取iv
    access_02 = data["access_02"]
    key = base64.b64decode(access_01).hex()
    # # 自实现算法
    i = int_to_byte_big_six(time).hex()
    # # 拼接
    iv = base64.b64decode(access_02).hex() + '' + i
    # # 解密 nft_used_info
    d = remove_invisible_chars(decrypt(nft_used_info_res, key, iv))
    return d

def int_to_byte_big_six(n):
    return bytearray([(n >> 40) & 255, (n >> 32) & 255, (n >> 24) & 255, (n >> 16) & 255, (n >> 8) & 255, n & 255])

def remove_invisible_chars(s):
    """移除所有不可见字符，除\n外"""
    str = ''
    for x in s:
        if x != '\n' and not x.isprintable():
            str += ''
        else:
            str += x
    return str

if __name__ == '__main__':
    # token_login密文
    token_login_req = "c17e952946323a958f9a6db55909ab349064e53b53a93b7b0008867e1512bc6f05c0c035619c74c21addc143627384749f7ca39894d0ba89fb773ee17fbb51a0c550ce818f0cdb4e063579b1a18efff12140321d33db3afaabd7da83c20c8492400cd2c2e4c0137bcdfbc045475d115526c03807af15aa96ff90e7824727d53f4489744c37027cfd51a23f276385421650aa549e6e96cf3a5c72bc17e38831ef7a00a370ca3c1cf35b16538abd32e2c97cfc0922ffbbd98661fdf64adb6c888d77e7f59a94981998318c1199b94fa7efe99ce5f72c6c9a5b9a5480bedb3c707263ca7e05ad3a08dd486ca184131d863584058d88750dc37e018cb9db68f4d7a144bf058ba9663d83c2aa7d318e251da6e25607d347e984bd50741832041746b317b1f9e7ee9513870a61c1d4b3a010e43c22c9efc151edb5bf0a33f3c8225f63f523f724dd3f4dc7144d81a2d34bcb9c837c23c72c138dd74b3bfebe94e5704f72707ef31c0f67f863e6c4638d0f6ce69f9d736b68afe274aff528f2db0b8aea81366d2bd51b3072c2dc3a037fb8ed63ca4be4d1921585c2262fb10ca6ff34b8c09d262e91116926d2a4c3fdf4254ec03c77011d736c9fc5347f46339bf6b2b0974359dc7a9041f0fbd091eb18e1a1c4d0297ecdce4860f875b08e9d96777f9a770258319fc95cf02faa2fafc50ad0f3"
    token_login_res = "5983ff0ef5a58dcb4cff786360ed1a69b4052b59e4a5f3235c8b6f22ef4c28e1c6188b6f348cd3da925ad43fbc04996b6247f6abde7ac96edc2d6f506446dd0832de3f1e66ab5b1e46fecb576843c83b4af5c75bb5cf76cfeaa401bb5e74ed93d07dce2b84ec153c0d2295bdde8a4282440946e6e95668e9ecac35b1521fd7b4e0b79ecca875547997b86d3c39ce7cffad930707430e41260cc3229f9c0a5b8c8c48b9e35322990bc2d134837c983f272515249600fbd6e69c8811c75337c86c5ed5fdb4630c78c968af41e1d0dfdf96101198854a9589afcad856d99b6bf76440e489e0607f685513cf7456b3d63a45d099cd48db17eeac2dee7aed84d1744d91f5d0f49b68754117d85db2e392afcd1599375006172821fda90019b868f21f5900693336f9e6df8373e1bffecdcd84897dd248eb899f575e9cea1c28f8f560acf39eaa241907cd7c0aa9cb7864b576fdebafa823b8b71ef7cdbea4e4c2f58e7f93369c87b4ad31639c78a743a1d5114754f7d4f8ee8e52275304de37bb76052cc328a39a2f8fc76d28de4dc8117c595214f068cd1c6f1f3d78d00ad72b1c80eae5ad3c685fa95da4812972e354715d003b500006172629b95890d82d7924cffe77d7f804a988c83b8af6f7918765fb01a6d1fb6e3727c2b9a3e5692ded2052485b74025b55f632992351b6397d3eaefb8ebf9552b98c837818a524a67ae8225e1d1df7e7cf3f6a5d5118e1b217e9519a009c93c2a08dde31f17168eb564482ffcb3ccd08d1127d47b5fef2a3520f511751af089e732a7f049475622e6102405ae57a2313296df59f602d5381b97f2e89bfbab07c9a69a540923fda90f585a00777b4558a39b29f7ca21a296948ed1e73f7c67f732ace1c2105071f44edeef299cb83d1a787284744b648dc2a358da6c2914b12d7cc56582b30be766e22257345f13973369b7cf4084ab3ba502b1d08eb65b92270188f66ae56ff352385c2d1017696b4d5aea8d8912c9e4b11f8167c947bed6b7ce481b286a90015d7155b1620916c37da5b2a5510b8736f734a8bf6"
    token_login_req_time = 1681095175
    token_login_res_time = 1681297189
    # nft_used_info密文
    # nft_used_info_req = "11fbcd8a3b0650f21263613bdd4563ee9b968c504721395b55f17cda8c6270e4705623b460c5ee9011dd03e8f322612020ba8d7f9582499dd39cc924371a94fe57c614fb6b819b287c820c1da5b67080caeb0b0c578b8203a8e8512f6dd92ebbc15b4a498a7edf9940f1471d18d40d0ba7d81fe5a1cf64889e8435bc5da00d93b245778f4b3dcc9149149b002c4971326be0e1e301cc15e31162d7ec7ba9cc7387d150e1ad3c5666b7751442b58ca7dcc1f58624b73ad655942434bf7ba56d11fbd5e8245ab550ad9e6b3265ab379ba5620c9ebccddee48c129d0f8361fc4c64ceed938261e676800ea73bba32a622f236fa6d6f87c65e4e7a63ec532f80d901919bb03418b0dc2ca84510807b14c3c18fe277ac44c780cec0d431c38c9d0329fc81f00280a8e0f57fb11e82bc2f9f1d"
    # nft_used_info_res = "88ecf458cd3646cb1341f2f54600462f7daf2f4c3c79959ccf235a6b4c111082eb89b039251410617c3db68d2bd998670e00ad9cde4821bbab2903b24cbe1a3dc27d84b599d735730d7fed4d7de984329a78d6494e7a2246ca879298fc34625e6e16b12d59ba6bb64915a3ff26a16eda3b5de7135bab6206369e971ae9986b913780c9ffc191b6a78538560e6b5f2dfe50a7ecc4c8d2b2bcb1040f6951ff19ab8705aed11dd69cb7f110e73ee6c1063ea9b97d68ebf500758177945f5ccb4e9c13616c52f281cd3a084b48f1f93eea94cabb2a5dfceeb60c11a14aacab204e9072ff6f70beaba6b5722ec3fd62db3885a955dd7b99f49ec66364cbe6a74eff505c17eeebd6724c96c6d54ae11d01f0ae357fac1e0fb976ccd0dec2a6e10cf6eb29ab270d8a00369cdba7f56c24f3332068f14722627babf83422d5b02254bbf664cf77e9f757f132f441466a9dfcbf7647cec71fbb8c1e81dbc6efb33f7da575d4c716ad92a2ec2e1e4b06891af9fbf49174428e42e56a6925acac66b264c0e2298185b6a898289e097a51fb61252e7e7330462a245480df4c362dafaa73e70c03a4dc06afa61e8210da1ab111ff40d78ac5efab1c01ff7398c48d6cc93604ff72899679c58af3716b4e0f2a7d09dc218c8652b336886ae155e23476cf35696d1f3e1e764c7f86f4b2fee027e22a5087c17f13bad3b9622d0021cc4e5a2de4832188f2d3d413a7f2c9c4bb1bfadb39c8316f90638608ca1d3352d01aa57d7ab898ed4fa8f434858524ee9f96e0408a3c73abe2e0cfc375520232ec4395d7ae0664439ee2caedfd41e4d10eee9af1a814b21d25a11e0a46add497f57796ce98538ecb0310aea103a51a7a50b46b951034c92dc959035e2cef259bad54b7244a02f462d35731e25d396a26e0a487d55bad5b7545e7fe3a53ba46422b735c7d4ae7bf4dcc5249f49c5e96aab158362001c57acdde262b05767eb29e89d8b10376d8bbaf7297255ee2c892467d7ef56fd3a54473ed9d705542adc5880b3e8785315004c276756aa68c2a5f9a052d39ca8a466e84aa9a1b7ecfe913d633d1ece6c2b66b066f332261c0106d125faa44c0ce8cc3907f312210e42decf4400fbd2fdf7eab7c0923934c60a10249f541b2b74ee2d416d87cecf52cb60e76019cbb6cfd5c31f26df98670e73f10dbd0d3f9f2c6869e0068e2c72865619f483e059144c651cf60f5cfc39c624b0e7dec570441ef0931a6760814547736f7ebf569b38a6afd6946d48c0fe93155124deea20ae7caf5ff518db3b75c361f36c9aefa8b754b988ea3b8861969989a3030b8039bcf22cab7af4faeda603e1aac6ccc1695c90ee869d199e370b56658aa85d4e73167a23fa4424da1d2af6c161f2a0e82b5901317358b9df896affb5fba86a368279ec781e6f7c9bc86c270f7700ee0d6a190bca13025fd432b7c3becc388710871b1b8dbafc273883becde59e1a795ce39ccefc39c0e5a43ecf37e5ac41c0d73e86d8c93fd04c3e91e470099bf441a41e0c2fc53c1247c2b56c92b2e70716c88dea90b87bdd21f55fd166ccb00b29059baec2599971d77c17d3c09b5a98dced7ce0fd486458501d0766c853ff6d76c866b816bd6d3663216b689db3bd04b04e2da4bc7a398a8a9df3dc649bd75bb17f3d56498172be7b5cfd3bc3c7eb2cf38b428ce211f12ed563726c540c5b935deb2085435698f5d6e796f0b01ba2b0bee4973859ff7d94f852601c4510c26a919ab2f43d99475c812cd59808153e91cf8290f6c78f17d14521ae794ac8a1b1681542b11cb345170befad48aed91aa2a61af9f9f0e3af5aca3ceefb31f26e20b2ee8d164d8efc374a12ce7e23aef149548adfc30fc1597030d9d70f0f16ccd698a0a847ca7301df8321ecf3de70685d67c59a25e1e7c434cb6292ffb7c947e0b955d058c3781b8a10a41ad85f9c0ee704d8f256e08c5ef4f665d8a078c5c59586eee3dfb3ba114d58ae255111ca62f566635cda6a8d3d97dfbbf48b49b18dc5f6a07cba6d7feee348e2d810705be296cc5feaf3693706cbdf0acfbecb59a7115eb52ceab59a76804bbe721c5afc0a900a525ebbfc912bd7a0a9af775ac74327bf2459b348738811ef299c6224c0d9ec8f5adb108c9eb9e73ae014965569e1025a9d9133c385df11b4087caf662faefef51c814864dcc2fd8220e7fced3d526a79d36affdeaa22623f99e482dfe10972cdf086d87e59636f0d8f1aaf6e18681c8bf74ff20e4d8"
    # nft_used_info__req_time = 1681300864
    # nft_used_info_res_time = 1681300864
    # email_reg_code密文
    # email_req = "aa4459b6523936aad096001b9cc34a3689a066ca4b850032768fd6ba3a79bb40dc57ddf4012c405f84f7edc26b3a93f875afddae1bca62c243746ca579734369a652b3357b976bd3a78b6480396bdbfd1d14d5c2d0f84a93f22219899b6a2d22aa5d5ba13d4b93c6f51dcdef06067ab2159394a65470827098db857ef226e6e952b475d4256fb839e4369b3311837fa20f6366d90ccfc8cc33a9e44194cf644f117253ab7ae39a7f18bc74f29bdeee07766225e1459c75c292bc8e8daf64b046b15cbadcc9f1f573530163dc7342b8c02512132624ee2ddba7c70ace4fec74c84dbd8420475708f9caccac528ca25428c48373e186439ef4614e75ae20b2b9993e9c81d0475ae0b431285268a71ba5984c8df8946a7cb5ba1df60ae143966df7f901ae5e09446779f7ca9521ba56c410cd51a3d9d460091917305ec12a798fd08cd816644be70512c195be2b22df574b"
    # email_res = "c440bc6aa6125e7e7302b1cdb3646eff7260fa971aa29f1031eaa975a86d736e70a5aa9011755365bb445f2c2c40eb3c"
    # email_req_time = 1681300587
    # email_res_time = 1681300587
    # email_login密文
    # email_login_req = "19e070281baba0ca859b56211041d4c609d8cf1e32eac6c89276009cde3a8c02352f908d0110d2ab1b03ca3d76f504096a54006ac1123f665ddd93bc0a3cfc6cecdcd27a7be503247cce3fe6fa63d0965cf1d1bfb00527dfd776474d9bd18613bbc6164388539c08af61fd53c6059fea33d52798f7d90ddc7def2c04e372c481135e161ed180be6a5a6a60a3ca8a3ef3bbfcdceb1f8e3681c28bb3e42e6548473982c242dd5a35d42b14e5857c88f69f27563b9c0cddf18292cf887244d82acbbf4c33f0aa0fef259c14e16c3f35a06630ab46eacabffa2a5ca8e4eed0af110f7fa5a1a7fd569ba2e8716d52f4698b721cbe8099071922666ee8baeb18d0ff2f2a4145120004008ac2cf585f0e69eab7f58ee4f970a103b79dd355fd5a50b24e6b37ccecd3dec312ffc3224b62ff627e2b4cc9d367a1bf4cb66a7637f58e6cd691e85d194b1b7c31ebf80d7ccb0ffde3ff59c37c65dba8b7da1c937ee87bb97f"
    # email_login_res = "4d63f19fb31c0c23f3b34a1bc67062bc75c671e885ca7bc19c69fc55a5233008b691e494b22b6515effdd78cb30f11659580e113487fb5bd43b9a49dd40480ba14421740c4b06cfa3f721a5bc35e21496129ecea47f2e698b3a3a5a56648663289ec984a039f00f53c2ae72c7fc67b180d7baa9ba5fd884905367dedab84d01868be6da4bef1345abc596a4868d8f25f432c7a8b03186784e3863d907948693c75f699fe218982681f208659e9ec14a7f228d89fad7a0073c729dd6a401509e9d44a3551b615eef743b39079e0e5b77b455460cc965d09d4fbeb4ca11efb5fade3efd18ff02382f78acff3bc1923e87ac1bf8e09cccd247a124fca2ed3c71c12f4bc046c2588fe8cd3768ab9317aea3c36fcc26c2d7557fd9896a3ce0e2432a7422e6175643a209ffc484a1a403474f23f7339a6ee2b16c0660b05d722087afb5da0652eefb991e669367489e660e0fa47de3beac449542cb124b60da7a7ed1c9d097e19448315ec2c2706c52831f579f7f03d5fe8cbddb936b74f3042ce7d610feb8086f6590ee9b2e1217da5ffe5fd56eab15dc258149a2d6d286023e5e21e3371947ab0d07038145be823689792da1490c794d89c77524aca330fa0b848cbe7c53f62e37133e819c1276cafcb899ef89e51a4319a87c196c17c3635c5ced1aa696106cf85cad97256a6b130c36a90eb598237cc101f06b401f2d012e98d11453f7f5cac60873549b9b3b6a479956b98d91e290ab5439f0f7b69059315770b50f35625ace946f7dd2d87ea37c69b51777061d757e49f0e3f12b0d259b37bbf262700eab0b550f78946328a09c070c8ebc0c9e5008ecbd91739ad85cf1ce5e2e5a2979e9507fda6ef04406eb3dc6171db46bda5915bdc84ec34a61972fd22d2462b5f29f2d07b74b4c44e33f70c2e686cf0236701bf4b85a04f8dd65103c2dceee239d6279ca2412cfe853bcb76e3aa2215067eaf15d2ea7cb76fb919253b12bf079067dc2fa00e905d99b427197bf039c3297f73ba6f76f6d14b57771897b88730c34224cedd590a8c4b217f9c963c"
    # email_login_req_time = 1681300863
    # email_login_res_time = 1681300863
    # 随便找的一个密文
    # test_req = "11fbcd8a3b0650f21263613bdd4563ee9b968c504721395b55f17cda8c6270e4705623b460c5ee9011dd03e8f322612020ba8d7f9582499dd39cc924371a94fe57c614fb6b819b287c820c1da5b67080caeb0b0c578b8203a8e8512f6dd92ebbc15b4a498a7edf9940f1471d18d40d0ba7d81fe5a1cf64889e8435bc5da00d93b245778f4b3dcc9149149b002c4971326be0e1e301cc15e31162d7ec7ba9cc7387d150e1ad3c5666b7751442b58ca7dcc1f58624b73ad655942434bf7ba56d11fbd5e8245ab550ad9e6b3265ab379ba5620c9ebccddee48c129d0f8361fc4c64ceed938261e676800ea73bba32a622f236fa6d6f87c65e4e7a63ec532f80d901919bb03418b0dc2ca84510807b14c3c18fe277ac44c780cec0d431c38c9d0329fc81f00280a8e0f57fb11e82bc2f9f1d"
    # test_res = "86f1352d22f6e38447ca4e3709d26d2239bec00e3259df9b7462191d5a472ca975d10da1155e511896a91d4d694b6a185a413da58033bea46c118fdce102775e365875d75ceb015edece76483d3803ba2e33c5fdbfdca53062843a63ed9980026a5d6fb364d321f10da595c38ceb5912417d569a91ed042206d37822a3893dde"
    # test_req_time = 1681300864
    # test_res_time = 1681300864
    # 解密 token_login 获取密钥
    token_login_req = decode_token_login(token_login_req, token_login_req_time)
    token_login_res = decode_token_login(token_login_res, token_login_res_time)
    print("token_login Req: ", token_login_req, "\ntoken_login Res: ", token_login_res)
    print()
    # email_req = decode_email(email_req, email_req_time)
    # email_res = decode_email(email_res, email_res_time)
    # print("email_req Req: ", email_req, "\nemail_res Res: ", email_res)
    # print()
    # email_login_req = decode_email(email_login_req, email_login_req_time)
    # 这个接口的作用与 token_login_res 一样, 服务器会下发密钥用于解密之后发送的所有数据包
    # email_login_res = decode_email(email_login_res, email_login_res_time)
    # print("email_login_req Req: ", email_login_req, "\nemail_login_res Res: ", email_login_res)
    # print()

    # nft_used_info_req = decode_all_data(email_login_res, nft_used_info_req, nft_used_info__req_time)
    # nft_used_info_res = decode_all_data(email_login_res, nft_used_info_res, nft_used_info_res_time)
    # print("nft_used_info Req: ", nft_used_info_req, "\nnft_used_info Res: ", nft_used_info_res)
    # print()

    # test_req = decode_all_data(email_login_res, test_req, test_req_time)
    # test_res = decode_all_data(email_login_res, test_res, test_res_time)
    # print("test_req Req: ", test_req, "\ntest_res Res: ", test_res)
    # print()